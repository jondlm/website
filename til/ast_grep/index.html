<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="description" content="Jon's personal site."><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/website/favicon.svg?v=2"><link rel="alternate" type="application/rss+xml" title="Chez Jon" href="https://jondlm.github.io/website/rss.xml"><meta name="generator" content="Astro v4.16.3"><title>Powerful refactoring with ast-grep</title><link rel="stylesheet" href="/website/_astro/blog.-JKPVJtT.css"><script type="module" src="/website/_astro/hoisted.CfyTAeD1.js"></script></head> <body class="px-4 md:px-16 lg:px-32 xl:px-64 2xl:px-96 container mx-auto pb-2"> <div id="sentinal" class="h-6"></div> <div id="nav-stripe" class="print:hidden bg-slate-900 top-0 right-full left-0 w-full fixed opacity-0"></div> <nav id="navbar" class="print:hidden flex mb-8 px-2 pr-5 py-2 bg-slate-900 rounded-lg border border-slate-900"> <div class="flex-auto flex items-center"> <a href="/website"> <img src="/website/_astro/home_handwritten.DLN5N5L3_Z1ER9WK.svg" alt="home" loading="eager" width="65" height="25" decoding="async"> </a> </div> <div class="flex flex-auto items-center justify-end space-x-4"> <a class="text-slate-100" href="/website/values">values</a> <a class="text-slate-100" href="/website/blog">blog</a> <a class="text-slate-100" href="/website/til">TIL</a> <a class="text-slate-100" href="/website/resume">resume</a> </div> </nav>  <article class="md"> <h1 class="mb-2">TIL: Powerful refactoring with ast-grep</h1> <div class="flex items-baseline"> <div class="text-gray-500 mt-0 -mr-2 text-sm"> 2025-01-03 </div> <ul> <li class="text-gray-500 text-xs border border-gray-400 rounded-full px-1.5 mr-1 inline-block">tools</li> </ul> </div> <p>I recently learned about a tool called ast-grep. It’s a powerful CLI tool that can find and replace bits of code based on their ASTs. In unix terms it’s a superior grep and/or sed for code. It’s backed by tree sitter giving it support for a dizzying number of languages.</p>
<p>This week I’m migrating an old codebase from Node 14 to 22. Some of the packages were using an old package <a href="https://www.npmjs.com/package/esm">esm</a> that added support for <a href="https://nodejs.org/api/esm.html">ECMAScript modules</a> before Node had native support for them. I had to remove the package because it doesn’t work on Node 22 anymore. As part of moving to Node’s native es modules I had to rewrite a bunch of imports to include the full path and extension. For example if we previously had <code>import utils from './utils'</code> it now needed to be <code>import utils from './utils.js'</code> because the old way was ambiguous.</p>
<p>Here’s an example showing how to find import statements for local files that start with <code>./</code> or <code>../</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#85E89D">language</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">js</span></span>
<span class="line"><span style="color:#85E89D">rule</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  regex</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"^[</span><span style="color:#79B8FF">\\</span><span style="color:#9ECBFF">.]{1,2}/.*$"</span></span>
<span class="line"><span style="color:#85E89D">  kind</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">string_fragment</span></span>
<span class="line"><span style="color:#85E89D">  any</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    - </span><span style="color:#85E89D">inside</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        stopBy</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">end</span></span>
<span class="line"><span style="color:#85E89D">        kind</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">import_statement</span></span>
<span class="line"></span></code></pre>
<p>You can include a top level <code>fix:</code> property to perform replacements but I left it out of my example. If you do include a fix you can run the rule like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#B392F0">sg</span><span style="color:#9ECBFF"> scan</span><span style="color:#79B8FF"> --interactive</span><span style="color:#79B8FF"> --rule</span><span style="color:#9ECBFF"> some_rule.yaml</span></span>
<span class="line"></span></code></pre>
<p>It’ll helpfully prompt you for each file modification.</p> </article>   </body></html>